stages:
  - build_test
  - deploy

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
  CACHE_PATH: ".m2/repository"

cache:
  key: maven-cache
  paths:
    - $CACHE_PATH

.build_test_template: &build_test_template
  tags:
    - factory-monitoring-api
  stage: build_test
  script:
    - chmod +x build-test.sh
    - ./build-test.sh

# ----------------- BUILD + TEST JOBS -----------------

build_test_api_gateway:
  <<: *build_test_template
  before_script:
    - cd api-gateway
  only:
    changes:
      - api-gateway/**
  artifacts:
    paths:
      - api-gateway/target/*.jar
    expire_in: 1 day

build_test_auth_server:
  <<: *build_test_template
  before_script:
    - cd auth-server
  only:
    changes:
      - auth-server/**
  artifacts:
    paths:
      - auth-server/target/*.jar
    expire_in: 1 day

build_test_config_server:
  <<: *build_test_template
  before_script:
    - cd config-server
  only:
    changes:
      - config-server/**
  artifacts:
    paths:
      - config-server/target/*.jar
    expire_in: 1 day

build_test_daily_report:
  <<: *build_test_template
  before_script:
    - cd daily-report
  only:
    changes:
      - daily-report/**
  artifacts:
    paths:
      - daily-report/target/*.jar
    expire_in: 1 day

build_test_five_minute_report:
  <<: *build_test_template
  before_script:
    - cd five-minute-report
  only:
    changes:
      - five-minute-report/**
  artifacts:
    paths:
      - five-minute-report/target/*.jar
    expire_in: 1 day

build_test_mail_service:
  <<: *build_test_template
  before_script:
    - cd mail-service
  only:
    changes:
      - mail-service/**
  artifacts:
    paths:
      - mail-service/target/*.jar
    expire_in: 1 day

build_test_mode_report:
  <<: *build_test_template
  before_script:
    - cd mode-report
  only:
    changes:
      - mode-report/**
  artifacts:
    paths:
      - mode-report/target/*.jar
    expire_in: 1 day

# ----------------- DEPLOY JOB -----------------

deploy:
  tags:
    - factory-monitoring-api
  stage: deploy
  script:
    - cp /home/sysadm/factory-monitoring/api-gateway/src/main/resources/application.yml api-gateway/src/main/resources/application.yml
    - cp /home/sysadm/factory-monitoring/api-gateway/src/main/resources/keystore.p12 api-gateway/src/main/resources/keystore.p12
    - docker-compose build
    - docker-compose up -d
  only:
    - main
  needs:
    - job: build_test_api_gateway
      optional: true
    - job: build_test_auth_server
      optional: true
    - job: build_test_config_server
      optional: true
    - job: build_test_daily_report
      optional: true
    - job: build_test_five_minute_report
      optional: true
    - job: build_test_mail_service
      optional: true
    - job: build_test_mode_report
      optional: true
